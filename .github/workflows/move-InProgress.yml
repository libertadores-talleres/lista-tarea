name: Auto move assigned issues to In Progress

on:
  issues:
    types: [assigned]

permissions:
  issues: write
  contents: read
  repository-projects: write

jobs:
  move-to-in-progress:
    runs-on: ubuntu-latest
    steps:
      - name: Move issue to In Progress
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const PROJECT_NUMBER = 1; // N√∫mero de tu proyecto (lo ves en la URL)
            const OWNER =  "libertadores-talleres"; // Owner del repositorio
            const STATUS_FIELD_NAME = 'Status'; // Nombre de tu campo de estado
            const TARGET_STATUS = 'In progress'; // Nombre exacto de tu columna/estado
            
            console.log('Issue asignado:', context.payload.issue.number);
            
            try {
              // 1Ô∏è‚É£ Obtener el Project ID y opciones del campo Status
              const projectQuery = `
                query($owner: String!, $number: Int!, $fieldName: String!) {
                  organization(login: $owner) {
                    projectV2(number: $number) {
                      id
                      field(name: $fieldName) {
                        ... on ProjectV2SingleSelectField {
                          id
                          options { id name }
                        }
                      }
                    }
                  }
                }
              `;
              
              const projectData = await github.graphql(projectQuery, {
                owner: OWNER,
                number: PROJECT_NUMBER,
                fieldName: STATUS_FIELD_NAME
              });
              
              const project = projectData.organization?.projectV2;
              if (!project) {
                console.log('‚ùå No se encontr√≥ el proyecto');
                return;
              }
              
              console.log('‚úÖ Project ID:', project.id);
              
              // 2Ô∏è‚É£ Buscar la opci√≥n "In progress"
              const statusField = project.field;
              const statusOption = statusField.options.find(opt => opt.name === TARGET_STATUS);
              
              if (!statusOption) {
                console.log(`‚ùå No se encontr√≥ el estado "${TARGET_STATUS}"`);
                console.log('Estados disponibles:', statusField.options.map(o => o.name));
                return;
              }
              
              console.log('‚úÖ Status Option ID:', statusOption.id);
              
              // 3Ô∏è‚É£ Buscar si el issue ya est√° en el proyecto
              const itemQuery = `
                query($issueId: ID!) {
                  node(id: $issueId) {
                    ... on Issue {
                      projectItems(first: 10) {
                        nodes { id project { id } }
                      }
                    }
                  }
                }
              `;
              
              const issueData = await github.graphql(itemQuery, {
                issueId: context.payload.issue.node_id
              });
              
              let projectItem = issueData.node.projectItems.nodes.find(
                item => item.project.id === project.id
              );
              
              let itemId;
              if (!projectItem) {
                console.log('‚öôÔ∏è El issue no est√° en el proyecto. Agreg√°ndolo...');
                
                const addItemMutation = `
                  mutation($projectId: ID!, $contentId: ID!) {
                    addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                      item { id }
                    }
                  }
                `;
                
                const addResult = await github.graphql(addItemMutation, {
                  projectId: project.id,
                  contentId: context.payload.issue.node_id
                });
                
                itemId = addResult.addProjectV2ItemById.item.id;
                console.log('‚úÖ Issue agregado al proyecto. Item ID:', itemId);
              } else {
                itemId = projectItem.id;
                console.log('‚úÖ Item ID encontrado:', itemId);
              }
              
              // 4Ô∏è‚É£ Actualizar el campo Status a "In progress"
              const updateMutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(
                    input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: { singleSelectOptionId: $optionId }
                    }
                  ) { projectV2Item { id } }
                }
              `;
              
              await github.graphql(updateMutation, {
                projectId: project.id,
                itemId: itemId,
                fieldId: statusField.id,
                optionId: statusOption.id
              });
              
              console.log(`üéâ Issue #${context.payload.issue.number} movido a "${TARGET_STATUS}"`);
              
            } catch (error) {
              console.error('‚ùå Error:', error);
              core.setFailed(error.message);
            }
